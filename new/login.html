<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ötödölő</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-deep: #1a1a2e;
            --panel-bg: #16213e;
            --accent: #4ecca3;
            --text: #eeeeee;
            --cell-px: 25px;
            --color-x: #ff4b2b;
            --color-o: #00d2ff;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Lobby Stílusok */
        .glass-card {
            background: var(--panel-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .pro-input {
            background: #0f3460 !important;
            border: 1px solid var(--accent) !important;
            color: white !important;
        }

        .btn-pro {
            background-color: var(--accent);
            color: var(--bg-deep);
            font-weight: bold;
            text-transform: uppercase;
            transition: 0.3s;
        }

        .btn-pro:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 204, 163, 0.4);
        }

        .btn-kick {
            background-color: #ff4b2b;
            color: white;
            border: none;
            padding: 2px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .host-badge {
            color: #ffd700;
            font-size: 0.75rem;
            border: 1px solid #ffd700;
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: 8px;
        }

        /* Játéktér Stílusok */
        h1 { color: var(--accent); letter-spacing: 5px; margin: 20px 0; font-weight: 800; }

        .status-badge {
            margin: 20px auto;
            padding: 12px 40px;
            background: var(--panel-bg);
            border-radius: 50px;
            border: 2px solid var(--accent);
            width: fit-content;
            font-size: 1.2rem;
        }

        .board-scroll-area {
            max-width: 95vw;
            max-height: 65vh;
            overflow: auto;
            border: 4px solid var(--panel-bg);
            border-radius: 12px;
            background-color: #222;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #game-grid {
            display: grid;
            grid-template-columns: repeat(50, var(--cell-px));
            grid-template-rows: repeat(50, var(--cell-px));
            background-color: #444;
            gap: 1px;
            padding: 1px;
        }

        .grid-cell {
            width: var(--cell-px);
            height: var(--cell-px);
            background: var(--bg-deep);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
        }

        .grid-cell:hover { background: #252545; }
        .marked-X { color: var(--color-x); }
        .marked-O { color: var(--color-o); }

        #game-arena { display: none; width: 100%; text-align: center; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--panel-bg); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }
    </style>
</head>
<body>

    <h1>ÖTÖDÖLŐ</h1>

    <div id="lobby-zone" class="container mt-4" style="max-width: 900px;">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="glass-card h-100">
                    <h4 class="mb-4 text-accent" style="color:var(--accent)">Beállítások</h4>
                    <input type="text" id="user_name" class="form-control pro-input mb-3" placeholder="Neved">
                    <input type="text" id="room_code" class="form-control pro-input mb-3" placeholder="Szoba kód">
                    <label class="small mb-1">Max játékosok: <b id="pc_val">2</b></label>
                    <input type="range" id="player_limit" class="form-range mb-4" min="2" max="4" value="2" oninput="document.getElementById('pc_val').innerText=this.value">
                    <button class="btn btn-pro w-100 py-2" onclick="entryRequest()">Belépés</button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="glass-card h-100">
                    <h4 class="mb-4 text-accent" style="color:var(--accent)">Játékosok</h4>
                    <div id="lobby_list" class="list-group border-0"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="game-arena">
        <div class="status-badge">
            <span id="turn-text">Várakozás...</span>
        </div>
        <div class="board-scroll-area mx-auto">
            <div id="game-grid"></div>
        </div>
    </div>

    <script>
        const API_PATH = "https://pepa.hu/api/jatekApi/otodolo";
        let myName, myCode, syncInterval;
        let gameOver = false;
        let localGrid = Array(50).fill().map(() => Array(50).fill(""));

        // 1. Belépés
        function entryRequest() {
            myName = document.getElementById("user_name").value.trim();
            myCode = document.getElementById("room_code").value.trim();
            const limit = document.getElementById("player_limit").value;

            if(!myName || !myCode) return alert("Töltsd ki az adatokat!");

            fetch(`${API_PATH}/player`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: myName, code: myCode, maxJatekos: parseInt(limit) })
            })
            .then(res => res.json())
            .then(data => {
                if(data.error) alert(data.error);
                else {
                    refreshLobby(data.user.players);
                    if(!syncInterval) syncInterval = setInterval(lobbyPulse, 2000);
                }
            });
        }

        // 2. Lobby folyamatos frissítése
        function lobbyPulse() {
            fetch(`${API_PATH}/lobby/${myName}/${myCode}`)
            .then(res => res.json())
            .then(data => {
                if(data.error) {
                    if(data.error.includes("not found") || data.error.includes("nincs")) {
                        clearInterval(syncInterval);
                        alert("A szoba megszűnt vagy kidobtak.");
                        location.reload();
                    }
                    return;
                }
                refreshLobby(data.user.players);
                
                // Automatikus indítás ha mindenki Ready
                if(data.user.players.length >= 2 && data.user.players.every(p => p.readyState === "ready")) {
                    initArena();
                }
            });
        }

        // 3. Lobby UI listázása
        function refreshLobby(players) {
            const list = document.getElementById("lobby_list");
            list.innerHTML = "";
            const isHost = (players[0].name === myName);

            players.forEach((p, index) => {
                const item = document.createElement("div");
                item.className = "list-group-item d-flex justify-content-between align-items-center mb-2 border-0 rounded text-white";
                item.style.background = "#0f3460";

                let content = `<div><strong>${p.name}</strong>`;
                if(index === 0) content += `<span class="host-badge">HOST</span>`;
                content += ` <small class="ms-1">(${p.readyState})</small></div>`;

                let buttons = `<div>`;
                if(isHost && p.name !== myName) {
                    buttons += `<button class="btn-kick me-2" onclick="kickPlayer('${p.name}')">KICK</button>`;
                }
                if(p.name === myName) {
                    buttons += `<button class="btn btn-sm btn-pro" onclick="setReady('${p.name}')">${p.readyState === 'ready' ? 'KÉSZ' : 'READY'}</button>`;
                }
                buttons += `</div>`;

                item.innerHTML = content + buttons;
                list.appendChild(item);
            });
        }

        // 4. Kick funkció
        function kickPlayer(target) {
            if(!confirm(`Kirúgod ${target} játékost?`)) return;
            fetch(`${API_PATH}/player/${target}/${myCode}`, { method: "DELETE" })
            .then(() => lobbyPulse());
        }

        // 5. Ready funkció
        function setReady(name) {
            fetch(`${API_PATH}/player/${myName}/${myCode}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: name })
            }).then(() => lobbyPulse());
        }

        // 6. Játéktér inicializálása
        function initArena() {
            document.getElementById("lobby-zone").style.display = "none";
            document.getElementById("game-arena").style.display = "block";
            const grid = document.getElementById("game-grid");
            if(grid.children.length === 0) {
                for(let r=0; r<50; r++) {
                    for(let c=0; c<50; c++) {
                        const cell = document.createElement("div");
                        cell.className = "grid-cell";
                        cell.id = `cell-${r}-${c}`;
                        cell.onclick = () => submitMove(r, c);
                        grid.appendChild(cell);
                    }
                }
            }
            setInterval(fetchGameState, 2000);
        }

        // 7. Lépés beküldése
        function submitMove(r, c) {
            if(gameOver || localGrid[r][c] !== "") return;
            fetch(`${API_PATH}/turn/${myName}/${myCode}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ data: JSON.stringify({ r, c }) })
            }).then(res => res.json()).then(updateBoard);
        }

        // 8. Játékállapot lekérése
        function fetchGameState() {
            if(gameOver) return;
            fetch(`${API_PATH}/turn/${myName}/${myCode}`).then(res => res.json()).then(updateBoard);
        }

        // 9. Tábla frissítése és győzelem ellenőrzése
        function updateBoard(res) {
            if(res.error || gameOver) return;
            const players = res.user.players;
            const turnIdx = res.user.currentPlayer;
            
            document.getElementById("turn-text").innerHTML = `Soron következik: <b style="color:var(--accent)">${players[turnIdx].name}</b>`;

            if(res.data) {
                try {
                    const move = JSON.parse(res.data);
                    const cell = document.getElementById(`cell-${move.r}-${move.c}`);
                    
                    let lastPlayerIdx = (turnIdx - 1 + players.length) % players.length;
                    let symbol = (lastPlayerIdx % 2 === 0) ? "X" : "O";
                    
                    if(cell && localGrid[move.r][move.c] === "") {
                        localGrid[move.r][move.c] = symbol;
                        cell.textContent = symbol;
                        cell.classList.add(`marked-${symbol}`);

                        if (checkWin(move.r, move.c, symbol)) {
                            gameOver = true;
                            setTimeout(() => {
                                alert(`GRATULÁLUNK! A győztes: ${players[lastPlayerIdx].name} (${symbol})`);
                                location.reload();
                            }, 200);
                        }
                    }
                } catch(e) {}
            }
        }

        // 10. Győzelem ellenőrző algoritmus
        function checkWin(r, c, sym) {
            return (
                countDir(r, c, 1, 0, sym) + countDir(r, c, -1, 0, sym) >= 4 ||
                countDir(r, c, 0, 1, sym) + countDir(r, c, 0, -1, sym) >= 4 ||
                countDir(r, c, 1, 1, sym) + countDir(r, c, -1, -1, sym) >= 4 ||
                countDir(r, c, 1, -1, sym) + countDir(r, c, -1, 1, sym) >= 4
            );
        }

        function countDir(row, col, dR, dC, sym) {
            let count = 0;
            let currR = row + dR;
            let currC = col + dC;
            while (currR >= 0 && currR < 50 && currC >= 0 && currC < 50 && localGrid[currR][currC] === sym) {
                count++;
                currR += dR;
                currC += dC;
            }
            return count;
        }
        let lastProcessedData = null; // Segédváltozó az ismétlődések kiszűrésére

        function updateBoard(res) {
            if(res.error || gameOver) return;
            const players = res.user.players;
            const turnIdx = res.user.currentPlayer;
            
            document.getElementById("turn-text").innerHTML = `Soron következik: <b style="color:var(--accent)">${players[turnIdx].name}</b>`;

            // CSAK AKKOR dolgozzuk fel, ha van adat, és az NEM ugyanaz, mint amit legutóbb már kirajzoltunk
            if(res.data && res.data !== "{}" && res.data !== lastProcessedData) {
                try {
                    const move = JSON.parse(res.data);
                    
                    // Ellenőrizzük, hogy érvényesek-e a koordináták (elkerüli a null/0 hibákat kezdésnél)
                    if (move.r === undefined || move.c === undefined) return;

                    const cell = document.getElementById(`cell-${move.r}-${move.c}`);
                    
                    // Ki rakta le? Az API a KÖVETKEZŐT (turnIdx) mutatja, tehát az előző tette le.
                    let lastPlayerIdx = (turnIdx - 1 + players.length) % players.length;
                    let symbol = (lastPlayerIdx % 2 === 0) ? "X" : "O";
                    
                    if(cell && localGrid[move.r][move.c] === "") {
                        lastProcessedData = res.data; // Elmentjük, hogy ezt már feldolgoztuk
                        
                        localGrid[move.r][move.c] = symbol;
                        cell.textContent = symbol;
                        cell.classList.add(`marked-${symbol}`);

                        if (checkWin(move.r, move.c, symbol)) {
                            gameOver = true;
                            setTimeout(() => {
                                alert(`GRATULÁLUNK! A győztes: ${players[lastPlayerIdx].name} (${symbol})`);
                                location.reload();
                            }, 200);
                        }
                    }
                } catch(e) {
                    console.log("Még nincs érvényes lépés adat.");
                }
            }
        }
    </script>
</body>
</html>