<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ötödölő Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --bg: #1a1a2e; --panel: #16213e; --accent: #4ecca3; --text: #eee; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .glass-card { background: var(--panel); border-radius: 15px; padding: 20px; border: 1px solid #ffffff10; }
        .pro-input { background: #0f3460 !important; border: 1px solid var(--accent) !important; color: white !important; }
        
        /* Játéktér */
        .board-area { max-width: 95vw; max-height: 70vh; overflow: auto; border: 3px solid var(--panel); border-radius: 10px; background: #222; }
        #grid { display: grid; grid-template-columns: repeat(50, 25px); gap: 1px; background: #444; }
        .cell { width: 25px; height: 25px; background: var(--bg); display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 14px; }
        
        /* Játékos színek */
        .p0 { color: #ff4b2b; } .p1 { color: #00d2ff; } .p2 { color: #f9d423; } .p3 { color: #b06ab3; }
        #game-arena { display: none; text-align: center; width: 100%; }
        .status-msg { font-size: 1.2rem; padding: 10px; margin-bottom: 10px; background: var(--panel); border-radius: 50px; border: 1px solid var(--accent); display: inline-block; }
    </style>
</head>
<body>

    <h2 class="my-3" style="color: var(--accent); letter-spacing: 3px;">ÖTÖDÖLŐ</h2>

    <div id="lobby-zone" class="container" style="max-width: 800px;">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="glass-card h-100">
                    <h5>Csatlakozás</h5>
                    <input type="text" id="in_name" class="form-control pro-input mb-2" placeholder="Neved">
                    <input type="text" id="in_code" class="form-control pro-input mb-2" placeholder="Szoba kód">
                    <label class="small">Maximum játékos: <b id="pc_val">2</b></label>
                    <input type="range" id="in_limit" class="form-range" min="2" max="4" value="2" oninput="pc_val.innerText=this.value">
                    <button class="btn btn-success w-100 mt-3 fw-bold" onclick="join()">BELÉPÉS</button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="glass-card h-100">
                    <h5>Játékosok</h5>
                    <div id="player_list"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="game-arena">
        <div class="status-msg">
            Soron következik: <span id="turn_display" class="fw-bold">...</span>
        </div>
        <div class="board-area mx-auto">
            <div id="grid"></div>
        </div>
    </div>

    <script>
        const API = "https://pepa.hu/api/jatekApi/otodolo";
        const SYMBOLS = ["X", "O", "Y", "Z"];
        let myName, myCode, lastMove, gameOver = false;
        let table = Array(50).fill().map(() => Array(50).fill(""));

        // Segédfüggvény az ID alapú elemekhez (hogy ne legyen ReferenceError)
        const $ = (id) => document.getElementById(id);

        async function join() {
            myName = $("in_name").value.trim();
            myCode = $("in_code").value.trim();
            if(!myName || !myCode) return alert("Adj meg nevet és kódot!");

            let res = await fetch(`${API}/player`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ name: myName, code: myCode, maxJatekos: parseInt($("in_limit").value) })
            }).then(r => r.json());

            if(res.error) alert(res.error);
            else setInterval(lobbySync, 2000);
        }

        async function lobbySync() {
            let res = await fetch(`${API}/lobby/${myName}/${myCode}`).then(r => r.json());
            if(res.error) return;

            let players = res.user.players;
            let isHost = players[0].name === myName;

            $("player_list").innerHTML = players.map((p, i) => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-dark rounded">
                    <span>${p.name} ${i==0?'<small class="text-warning">[HOST]</small>':''}</span>
                    <span>
                        ${isHost && p.name!=myName ? `<button class="btn btn-danger btn-sm py-0" onclick="kick('${p.name}')">X</button>` : ''}
                        ${p.name==myName ? `<button class="btn btn-sm ${p.readyState=='ready'?'btn-success':'btn-outline-secondary'}" onclick="toggleReady()">READY</button>` : `<small>(${p.readyState})</small>`}
                    </span>
                </div>
            `).join('');

            if(players.length >= 2 && players.every(p => p.readyState == 'ready')) start();
        }

        function kick(n) { fetch(`${API}/player/${n}/${myCode}`, { method: "DELETE" }); }
        function toggleReady() { fetch(`${API}/player/${myName}/${myCode}`, { method: "PUT", headers: {"Content-Type":"application/json"}, body: JSON.stringify({name:myName}) }); }

        function start() {
            $("lobby-zone").style.display = "none";
            $("game-arena").style.display = "block";
            if($("grid").children.length > 0) return; // Már legenerálva
            
            for(let r=0; r<50; r++) for(let c=0; c<50; c++) {
                let d = document.createElement("div");
                d.className = "cell"; d.id = `c${r}-${c}`;
                d.onclick = () => {
                    if(gameOver || table[r][c] != "") return;
                    fetch(`${API}/turn/${myName}/${myCode}`, {
                        method: "POST", headers: {"Content-Type":"application/json"},
                        body: JSON.stringify({ data: JSON.stringify({ r, c }) })
                    });
                };
                $("grid").appendChild(d);
            }
            setInterval(gameUpdate, 2000);
        }

        async function gameUpdate() {
            if(gameOver) return;
            let res = await fetch(`${API}/turn/${myName}/${myCode}`).then(r => r.json());
            if(res.error) return;

            let players = res.user.players;
            let currentIdx = res.user.currentPlayer;
            
            $("turn_display").innerText = players[currentIdx].name;
            $("turn_display").className = `fw-bold p${currentIdx}`;

            if(res.data && res.data != "{}" && res.data != lastMove) {
                let m = JSON.parse(res.data);
                // Az API a következőt mutatja, tehát az előző tette le a jelet
                let lastPIdx = (currentIdx - 1 + players.length) % players.length;
                let sym = SYMBOLS[lastPIdx];
                
                if(table[m.r][m.c] == "") {
                    lastMove = res.data;
                    table[m.r][m.c] = sym;
                    let cell = $(`c${m.r}-${m.c}`);
                    cell.innerText = sym;
                    cell.classList.add(`p${lastPIdx}`);

                    if(checkWin(m.r, m.c, sym)) {
                        gameOver = true;
                        setTimeout(() => { alert("Vége! Nyert: " + players[lastPIdx].name); location.reload(); }, 300);
                    }
                }
            }
        }

        function checkWin(r, c, s) {
            const count = (dr, dc) => {
                let n = 0, nr = r+dr, nc = c+dc;
                while(nr>=0 && nr<50 && nc>=0 && nc<50 && table[nr][nc]==s) { n++; nr+=dr; nc+=dc; }
                return n;
            };
            return [[0,1],[1,0],[1,1],[1,-1]].some(d => count(d[0], d[1]) + count(-d[0], -d[1]) >= 4);
        }
    </script>
</body>
</html>